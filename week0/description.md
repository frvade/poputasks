# Poputasks
Система состоит из 5 основных сервисов, общение происходит через
message broker, у каждого сервиса может быть (или не быть) своя БД.

## Auth service
Сервис аутентификации и авторизации. При попытке входа в админку
сервиса, требующего авторизации, сервис будет проверять наличие токена.
При отсутствии токена, сервис будет редиректить пользователя на страницу
аутентификации (будем использовать oauth 2.0), где после ввода корректных
данных (фото клюва), Auth сервис выдаст токен и средиректит назад
в нужную админку.

Также этот сервис будет иметь функциональность смены роли попуга, доступную
админам.

### Создаваемые события
- Logged in
- Logged out
- Popug updated

## Task service
Сервис отвечает за создание задач, их ассайн, завершение. При создании и
каждом действии над задачами создает событие (-я), которые затем могут
быть (а могут не быть) обработаны другими частями системы.

Требует авторизации

### Возможные действия
- **Create task**. Может любой авторизованный пользователь
- **(Re-) assign task**. Может только пользователь с соответствующей ролью
- **Complete task**. Может только тот, на кого она сейчас назначена

### Хранимые данные
- **Task** (task_id, author_id, assignee_id, description, status,
created_at)

### Создаваемые события
- **Task created** (Task)
- **Task assigned** (Task)
- **Task completed** (Task)

## Billing service
Сервис обработки назначений/завершений задач. Также реализует
функциональность учета балансов и выплат сотрудникам.

### Хранимые данные
- **Task** (task_id, assignee_id, description
  (? "с подробным описанием каждой из задач"), status,
  assign_price (decimal), complete_price (decimal))
- **Operation** (amount (decimal), target_id (может быть task_id для
  операций по таскам, либо payout_id для операций по выплатам баланса),
  target_type)
- **Payout** (payout_id, popug_id, amount (decimal), date)

### Обрабатываемые события
- **Task assigned**. При получении проверяет, приходила ли 
уже задача (есть ли о ней данные), если нет, то назначает
цены по заданным формулам, сохраняет их в таске, и затем создает 
Operation списания денег с попуга, обновляет его баланс.
- **Task created**. При получении проверяет, есть ли уже данные о задаче
(если update пришел раньше), если нет, по заданным формулам назначает 
цены назначения и завершения, и сохраняет их в таске.
- **Task completed**. При получении проверяет, есть ли данные о задаче,
если нет, то кладет в очередь ретрая. Если данные есть, создает Operation
начисления денег попугу, обновляет его баланс.

#### Проблема
1. Мы можем получить события более 1 раза, и тогда возможны двойные
начисления/списания. Для исключения таких ситуаций сохраняем инфу
о тасках, и их статусе. Таким образом мы не будем переназначать цену,
если **created** уже приходил, не будем создавать списание, если
в **assigned** `assignee_id` совпадает с предыдущим, и не будем
создавать начисление, если пришел **completed** для таски, у которой
`status == completed`.
2. Можем оказаться в сложной ситуации, если assign произошел на того же
попуга, что и был. Можем решить эту проблему введением какого-то
assignation_id и проверкой, что он изменился.  
В целом для подобных ситуаций можно предусмотреть логику exactly once
delivery из message broker.

### Создаваемые события
- **Payout created** (Payout)

### Джобка выплат
Раз в сутки запускается джобка создания выплат попугам
(где-то после 00:00, с каким-то лагом, чтобы доехали события 
вблизи полуночи). Она выбирает всех попугов с положительным балансом,
и создает Operation на списания с баланса сумм.

#### Проблема
1. Есть проблема с тем, что событие assigned или completed придут после того,
как запустится джобка назначения выплат. Если у нас есть строгое
требование выплачивать точные балансы на конец суток, то придется
переделывать схему взаимодействия Task сервиса и Billing. Assigned и
Completed события надо будет передавать синхронно, чтобы при назначении
выплаты, у нас точно были все изменения за прошедшие сутки.
2. Такой же вопрос будет с балансом на конец дня. Удобно (и эффективно)
было бы иметь отдельную сущность баланса на каждого попуга, и выбирать
тех, у кого он положительный. Но есть риск, что в балансе могут быть
учтены события, появившиеся после 00:00.
Если мы не можем себе этого позволить, то будем хранить для каждого попуга
дату последней выплаты, а баланс будем иметь не один, а на каждый день.
Тогда приходящие события Assigned и Completed будут изменять не только
общий баланс, но и баланс конкретной даты. При запуске джобки выплат
будем выбирать балансы с последней выплаты до вчера
прошедшей полуночи, суммировать, и если сумма положительная, создавать
Operation списания, обновлять дату выплаты и минусить из общего баланса.
Можно было бы выбирать Operation с последней даты выплаты, но это должно
быстро привести к деградации перформанса джобки, особенно при большом
количестве минусовых попугов.

## Notification Service
Сервис рассылки уведомлений о выплатах (и не только при необходимости).

### Обрабатываемые события
- **Payout created**. При получении создаем и отправляем письмо попугу
с суммой выплаты.

#### Дополнительно
Можем добавить еще события отправленных писем, если появится такое
требование.

## Analytics Service
Сервис аналитики прибыльности сервиса. Отображает балансы на
данный момент/за период, самые дорогие задачи за период.

Требует авторизации. Обычные юзеры видят свой баланс и лог Operation.
Админы/бухгалтеры видят дополнительно баланс предприятия
(`(sum(created task fee) - sum(completed task amount)`), а также
аналитику по дорогим задачам за выбранный период.

Балансы можем хранить за каждый день, тогда сможем показывать не только
за сегодня, но и за каждый день, и за период.  
Для выборки самой дорогой задачи за период, будем просто выбирать
все самые дорогие таски за каждый день периода, и среди них искать
максимум.

### Хранимые данные
- **Day balance**. amount (decimal), date
- **Most valuable task of the day**. price (decimal), complete_date.
По требованиям это все, но имеет смысл добавить данные о задаче
(task_id, description, author_id, assignee_id),
чтобы можно было понимать, что за задача, кем создана, и кем закрыта.

### Обрабатываемые события
- **Task assigned**. При получении плюсует баланс предприятия за
текущий день на assign_price.
- **Task completed**. При получении минусует баланс предприятия за
текущий день на complete_price. Также сранивает цену с самой дорогой
за сегодня, и если цена пришедшей больше — обновляет данные

#### Проблема
Здесь будут проблема, аналогичная Billing Service из-за того, что
одно и то же **assigned** событие может прийти несколько раз, и мы
неверно посчитаем баланс. С этим помогут те же самые приемы: либо
event_id с ведением лога обработанных событий, либо гарантия от брокера,
что сообщение будет доставлено только 1 раз.